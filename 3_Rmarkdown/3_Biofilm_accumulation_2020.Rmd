---
title: "Biofilm metrics"
author: "Melissa DeSiervo"
date: "5/3/2019"
output: html_document
---
This is the R code for calculating Biofilm metrics from 2018 Greenland dataset. 

These data were collected by establish biofilm-meters in the field, scraping off the biofilm, filtering it onto glass fiber fibers, weighing the filters, burning the filters, and weighing them again. The raw data with filters, weights, number of strips scraped, and the weight of filters, filters +POM, filters + POM burned are in raw data/Biofilm filters.xls

For simplicity, I have already calculated AFDM (filter berfore burn - filter after burn) and standardized it to the amount of area scraped by cm. I also converted the numbers from mg to ug (X1000) per cm. Data were reorganized in excel to be by pond and sampling station, instead of by filter. Data were copy and pasted into inputs/BiofilmAFDM_2018

First, upload the data
```{r Upload data}

setwd("C:/Users/Mitzi/Dropbox/Mosquito Science (1)/Data 2011 to 2018/Github repository/Arctic_mosquito/C-R paper/Data and analysis/3- Biofilm metrics")

BiofilmAFDM <- read.csv("C:/Users/Mitzi/Dropbox/Mosquito Science (1)/Data 2011 to 2018/Github repository/Arctic_mosquito/C-R paper/Data and analysis/Inputs/BiofilmAFDM_2018.csv")

BiofilmAFDM$Date.1 <- as.Date(BiofilmAFDM$Date.1, "%m/%d/%Y")
BiofilmAFDM$Date.2 <- as.Date(BiofilmAFDM$Date.2, "%m/%d/%Y")
BiofilmAFDM$Date.3 <- as.Date(BiofilmAFDM$Date.3, "%m/%d/%Y")


```

Install necessary packages
```{r Upload packages}
library(dplyr)
library(ggplot2)
```

Calculate Biofilm productivity for each pond X sampling station. 
Take the Cage AFDM - Pre AFDM and divide by the number of days of the treatment UNITS=ug/cm/day, mg/dm/day, ug/dm/day

```{r Calculate biofilm productivity}

BiofilmAFDM_prod<-BiofilmAFDM %>% mutate(Prod.ug.cm.day=as.numeric(CageAFDM-PreAFDM)/DaysTreatment)%>% mutate(Prod.mg.dm.day=Prod.ug.cm.day/10)%>% mutate(Prod.ug.dm.day=Prod.mg.dm.day*1000)

```

Calculate Grazing pressure for each pond X sampling station. 
Take the Cage AFDM - NoCage AFDM and divide by the number of days of the treatment UNITS=ug/cm/day, mg/dm/day, ug/dm/day

```{r Calculate grazing pressure}

BiofilmAFDM_prod_GP<-BiofilmAFDM_prod %>% mutate(GP.ug.C.day=as.numeric(CageAFDM-NocageAFDM)/DaysTreatment)%>% mutate(GP.mg.dm.day=GP.ug.C.day/10)%>% mutate(GP.ug.dm.day=GP.mg.dm.day*1000)

```


ANOVA for productivity and grazing pressure
```{r ANOVA producticity GP}

prodmodel<-lm(Prod.ug.cm.day~Pond, data=BiofilmAFDM_prod_GP)
GPmodel<-lm(GP.ug.C.day~Pond, data=BiofilmAFDM_prod_GP)

##check assumptions#
par(mfrow=c(2,2))
plot(prodmodel)
plot(GPmodel)


anova(prodmodel)
anova(GPmodel)
```


Now calculate averages and standard error by pond
```{r Calculate grazing pressure}

BiofilmAFDMbypond<-BiofilmAFDM_prod_GP %>% group_by(Pond, Pond2, Date.1, Date.2, Date.3) %>% dplyr::summarise(meanProd.ug.cm.day=mean(Prod.ug.cm.day,na.rm=TRUE),seProd.ug.cm.day=sd(Prod.ug.cm.day,na.rm=TRUE)/sqrt(n()),meanProd.mg.dm.day=mean(Prod.mg.dm.day,na.rm=TRUE),seProd.mg.dm.day=(sd(Prod.mg.dm.day,na.rm=TRUE)/sqrt(n())),meanProd.ug.dm.day=mean(Prod.ug.dm.day,na.rm=TRUE),seProd.ug.dm.day=(sd(Prod.ug.dm.day,na.rm=TRUE)/sqrt(n())),meanGP.ug.C.day=mean(GP.ug.C.day,na.rm=TRUE),seGP.ug.cm.day=(sd(GP.ug.C.day,na.rm=TRUE)/sqrt(n())),meanGP.mg.dm.day=mean(GP.mg.dm.day,na.rm=TRUE),seGP.mg.dm.day=(sd(GP.mg.dm.day,na.rm=TRUE)/sqrt(n())),meanGP.ug.dm.day=mean(GP.ug.dm.day,na.rm=TRUE),seGP.ug.dm.day=(sd(GP.ug.dm.day,na.rm=TRUE)/sqrt(n())),controlAFDM=mean(NocageAFDM,na.rm=TRUE),secontrolAFDM=(sd(NocageAFDM,na.rm=TRUE)/sqrt(n())))


```

Paired T test Cage vs. No Cage
```{r Paire T Cage vs No Cage}

BiofilmAFDMbypond2<-BiofilmAFDM %>% group_by(Pond) %>% dplyr::summarise(meanCageAFDM=mean(CageAFDM,na.rm=TRUE),meanNocageAFDM=mean(NocageAFDM,na.rm=TRUE))

t.test(BiofilmAFDMbypond2$meanCageAFDM, BiofilmAFDMbypond2$meanNocageAFDM, paired = TRUE)


```



Export both two files
1) Biofilm productivity and grazing pressure by sampling station (to merge with pond metrics for the "Biofilm productivity.RMD")
2) Biofilm productivity and grazing pressure by pond (for 2/3 columns in Table 3)

```{r export files}
#1
write.csv(BiofilmAFDM_prod_GP, "C:/Users/Mitzi/Dropbox/Mosquito Science (1)/Data 2011 to 2018/Github repository/Arctic_mosquito/C-R paper/Data and analysis/Outputs/Biofilmmetrics_samplingstation.csv")

#2
write.csv(BiofilmAFDMbypond, "C:/Users/Mitzi/Dropbox/Mosquito Science (1)/Data 2011 to 2018/Github repository/Arctic_mosquito/C-R paper/Data and analysis/Outputs/biofilmmetrics.csv")

```


#1 data goes from wide to long
#2 need to add on a few categories to make a clean figure (
- change into beginning middle and end
_ make a dummy category for "Cage" and "No "Cage" 
- Merge them together
#3 summarize biomass by each pond

```{r prep data for figure}
#1 
Biofilm_long <-  BiofilmAFDM %>% gather(Treatment , Biomassugcm2, Beginning:CageAFDM, factor_key=TRUE)
 
Biofilm_long2<-Biofilm_long %>% mutate(Date = case_when(Treatment == "Beginning"~ Date.1,Treatment == "PreAFDM"~ Date.2,Treatment=="CageAFDM"|Treatment=="NocageAFDM"~Date.3))
                           

#2
Biofilm_long_2<-mutate(Biofilm_long2, Experiment = Treatment)

Biofilm_long_2$Experiment <- plyr::revalue(Biofilm_long_2$Experiment, c("Beginning"="Beginning", "PreAFDM"="Middle", "NocageAFDM"="End", "CageAFDM"="End"))


Biofilm_long_Cage<-mutate(Biofilm_long_2, Experiment2 = "Cage")%>% filter(Treatment=="Beginning"|Treatment=="PreAFDM"|Treatment=="CageAFDM")

Biofilm_long_NoCage<-mutate(Biofilm_long_2, Experiment2 = "NoCage")%>%filter(Treatment=="Beginning"|Treatment=="PreAFDM"|Treatment=="NocageAFDM")

Biofilm_long_all<-rbind(Biofilm_long_Cage, Biofilm_long_NoCage)

#3
summarybiofilmcurves<-
Biofilm_long_all %>% group_by(Pond, Pond2, Date, Treatment, Experiment, Experiment2) %>% dplyr::summarise(meanBiofilm=mean(Biomassugcm2, na.rm=TRUE), StdevBiofilm=sd(Biomassugcm2, na.rm=TRUE), SterrorBiofilm=(sd(Biomassugcm2, na.rm=TRUE)/sqrt(n())))


```




```{r Biofilm biomass figure}

##draw curves for each panel seperately##
mytheme<- theme_bw()+ theme(axis.line.x= element_line(colour = "black", size=0.3))+theme(axis.line.y= element_line(colour = "black", size=0.3))+theme(axis.text.x=element_text(size=8, colour = "black", angle=45,hjust = 1))+theme(axis.text.y=element_text(size=8, colour = "black"))+theme(axis.title=element_text(size=10))+theme(plot.title=element_text(size=7) +theme(plot.title = element_text(hjust = 0.5)))+ theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())+ theme(legend.position = "none")


summarybiofilmcurves$Experiment2<-factor(summarybiofilmcurves$Experiment2, levels=c("NoCage", "Cage"))
summarybiofilmcurves$Pond2<-factor(summarybiofilmcurves$Pond2, levels=c("1", "1a", "1b", "1c", "2a", "3", "3a", "4"))

summarybiofilmcurvesE<-subset(summarybiofilmcurves, Pond2=="1"| Pond2=="1a"| Pond2=="1b"| Pond2=="1c")
summarybiofilmcurvesEGINO<-subset(summarybiofilmcurves, Pond2=="1"| Pond2=="1a"| Pond2=="1b"| Pond2=="1c")
summarybiofilmcurvesOVVSW<-subset(summarybiofilmcurves, Pond2=="2a"| Pond2=="3"| Pond2=="3a"| Pond2=="4")

BiofilmgraphEGINO<-ggplot(summarybiofilmcurvesEGINO, aes(Date, meanBiofilm, group=Experiment2)) +geom_point(size=1)+ylim(0,150)+ geom_line(aes(linetype=Experiment2))+geom_errorbar(aes(ymin=meanBiofilm-SterrorBiofilm, ymax=meanBiofilm+SterrorBiofilm), width=0.2)+facet_wrap(~Pond2, ncol=4)+ylab(bquote(atop("Biofilm AFDM" , (~μg  ~C / ~  cm^{2}))))+xlab("") + mytheme+ theme(panel.spacing = unit(0.5, "lines"))+ theme(legend.position="none")+theme(plot.margin=unit(c(1,1,0,1), "cm"))+ scale_y_continuous(limits=c(0,150), breaks=pretty_breaks(n=6))+scale_x_date(limits = as.Date(c("2018-05-09", "2018-06-26")))+theme(axis.text.x=element_blank())


BiofilmgraphEGINO2<-BiofilmgraphEGINO+ theme(strip.text.x = element_blank())+ geom_text(aes(as.Date("2018-06-02"), 145, label=Pond2, group=NULL))


ann_text <- data.frame(Date = as.Date(c("2018-06-08", "2018-06-10"),"%Y-%m-%d"),meanBiofilm = c(62, 52), Experiment2=c("Cage", "Cage"),Pond2 = factor(c(1,1),levels = c("1", "1a", "1b", "1c")))

BiofilmgraphEGINO3<-BiofilmgraphEGINO2+ geom_text(data = ann_text,label= c("Grazer","Exclusion"), angle=30, size=3 )


BiofilmgraphOVVSW<-ggplot(summarybiofilmcurvesOVVSW, aes(Date, meanBiofilm, group=Experiment2)) +geom_point(size=1)+ylim(0,150)+ geom_line(aes(linetype=Experiment2))+geom_errorbar(aes(ymin=meanBiofilm-SterrorBiofilm, ymax=meanBiofilm+SterrorBiofilm), width=0.2)+facet_wrap(~Pond2, ncol=4)+ylab(bquote(atop("Biofilm AFDM" , (~μg  ~C / ~ cm^{2}))))+xlab("") + mytheme+ theme(panel.spacing = unit(0.5, "lines"))+ theme(legend.position="none")+theme(plot.margin=unit(c(0,1,1,1), "cm"))+ scale_y_continuous(limits=c(0,150), breaks=pretty_breaks(n=6))+scale_x_date(limits = as.Date(c("2018-05-09", "2018-06-26")))

BiofilmgraphOVVSW2<-BiofilmgraphOVVSW+ theme(strip.text.x = element_blank())+ geom_text(aes(as.Date("2018-06-01"), 145, label=Pond2, group=NULL))



##annotate first panel##


jpeg("C:/Users/Mitzi/Dropbox/Mosquito Science (1)/Data 2011 to 2018/Github repository/Arctic_mosquito/C-R paper/Data and analysis/Outputs/Figure4_annotate.jpeg",width = 6, height = 4,units = 'in', res = 600)
grid.arrange(BiofilmgraphEGINO3, BiofilmgraphOVVSW2 , ncol = 1, heights = c(1, 1.2), widths = 1)
dev.off()

```





